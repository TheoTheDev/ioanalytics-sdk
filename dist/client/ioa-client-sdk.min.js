"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ioaClientSDK=void 0;const generateUid=()=>Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15),detectBrowser=()=>{const e=navigator.userAgent;return/Edge\/\d+/.test(e)?"Microsoft Edge":/OPR\/\d+/.test(e)?"Opera":/CriOS\/\d+/.test(e)||/Chrome\/\d+/.test(e)?"Chrome":/Safari\/\d+/.test(e)?"Safari":/Firefox\/\d+/.test(e)?"Firefox":/MSIE \d+/.test(e)||/Trident\/\d+/.test(e)?"Internet Explorer":"Unknown"},detectOS=()=>{const e=navigator.platform.toLowerCase(),t=navigator.userAgent.toLowerCase();return/android/.test(t)?"Android":/iphone|ipad|ipod/.test(t)?"iOS":e.includes("win")?"Windows":e.includes("mac")?"macOS":e.includes("linux")&&!/android/.test(t)?"Linux":"Unknown"};class ioaClientSDKCore{constructor(){Object.defineProperty(this,"analyticsURL",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"projectId",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:{uid:"",state:"",sessionId:""}}),Object.defineProperty(this,"device",{enumerable:!0,configurable:!0,writable:!0,value:{os:"",resolution:"",pixelRatio:0,browser:""}}),Object.defineProperty(this,"performance",{enumerable:!0,configurable:!0,writable:!0,value:{stages:[],loadTime:0,matchmakingTime:0,avgPing:0,maxPing:0}}),Object.defineProperty(this,"eventsQueue",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"errorsQueue",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"updateIntervalId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"updateIntervalDuration",{enumerable:!0,configurable:!0,writable:!0,value:2e3}),Object.defineProperty(this,"lastPingTime",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"pingDelay",{enumerable:!0,configurable:!0,writable:!0,value:3e4}),Object.defineProperty(this,"update",{enumerable:!0,configurable:!0,writable:!0,value:()=>{(this.eventsQueue.length>0||this.errorsQueue.length>0)&&this.sendData(),this.lastPingTime+this.pingDelay<Date.now()&&(this.sendPingData(),this.lastPingTime=Date.now())}}),Object.defineProperty(this,"sendInitialData",{enumerable:!0,configurable:!0,writable:!0,value:()=>{fetch(this.analyticsURL+"/api/stats/start",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({uid:this.user.uid,projectId:this.projectId,device:this.device})}).then((async e=>{if(e.ok){const t=await e.json();this.user.sessionId=t.sessionId}}))}}),Object.defineProperty(this,"sendData",{enumerable:!0,configurable:!0,writable:!0,value:()=>{fetch(this.analyticsURL+"/api/stats/collect",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({uid:this.user.uid,sessionId:this.user.sessionId,events:this.eventsQueue,errors:this.errorsQueue,projectId:this.projectId})}),this.eventsQueue=[],this.errorsQueue=[]}}),Object.defineProperty(this,"sendPingData",{enumerable:!0,configurable:!0,writable:!0,value:()=>{fetch(this.analyticsURL+"/api/stats/ping",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({uid:this.user.uid,sessionId:this.user.sessionId,performance:this.performance,state:this.user.state,projectId:this.projectId})})}}),Object.defineProperty(this,"beforeUnload",{enumerable:!0,configurable:!0,writable:!0,value:()=>{fetch(`${this.analyticsURL}/api/stats/end?uid=${this.user.uid}&sessionId=${this.user.sessionId}&playerLeftState=${this.user.state}&projectId=${this.projectId}`,{method:"GET"})}});const e=localStorage.getItem("nwa-uid");e?this.user.uid=e:(this.user.uid=generateUid(),localStorage.setItem("nwa-uid",this.user.uid)),window.addEventListener("beforeunload",this.beforeUnload)}init(e,t="https://ioanalytics.dev"){this.projectId=e,this.analyticsURL=t,this.lastPingTime=Date.now(),this.detectDevice(),this.updateIntervalId=setInterval(this.update,this.updateIntervalDuration),this.sendInitialData()}setFPS(e,t,i){const s=this.performance.stages.find((t=>t.name===e));s?(s.avgFps=t,s.minFps=i):this.performance.stages.push({name:e,avgFps:t,minFps:i})}setState(e){this.user.state=e}newEvent(e,t){this.eventsQueue.push({type:e,event:t,date:new Date})}newError(e,t){this.errorsQueue.push({type:e,error:t,date:new Date})}detectDevice(){const e=detectBrowser(),t=detectOS();this.device.browser=`${e} (${t})`,this.device.os=detectOS(),this.device.resolution=`${window.innerWidth}x${window.innerHeight}`,this.device.pixelRatio=window.devicePixelRatio}dispose(){clearInterval(this.updateIntervalId),this.updateIntervalId=null,this.eventsQueue=[],this.errorsQueue=[],this.performance={stages:[],loadTime:0,matchmakingTime:0,avgPing:0,maxPing:0},this.device={os:"",resolution:"",pixelRatio:0,browser:""}}}exports.ioaClientSDK=new ioaClientSDKCore;